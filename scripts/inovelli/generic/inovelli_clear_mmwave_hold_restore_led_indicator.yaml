alias: HOLD OFF - Inovelli Clear mmWave Hold + Restore LED Indicator
description: >
  Forces MmwaveControlWiredDevice back to normal_mode and restores LED 1-7
  colors from cached helper (fallback 255). Does NOT clear the helper (matches
  toggle behavior).
fields:
  switch_name:
    description: >-
      Entity name prefix used for BOTH the mmWave select entity and the LED
      number entities
    example: upstairs_primary_water_closet_inovelli_presence
  normal_mode:
    description: The mmWave dropdown option that represents NOT on hold
    example: Occupancy (default)
  normal_mode_input_select:
    description: >-
      Optional input_select helper whose state matches the switch's
      MmwaveControlWiredDevice options. If provided, this will be used instead of
      normal_mode (normal_mode becomes a fallback).
    example: input_select.basement_rumpus_room_mmwave_normal_mode
  hold_color:
    description: >-
      Optional 0-255 color index (or input_* helper entity) that identifies
      holds created by automation. When provided, the hold will only be cleared
      if LED1 WhenOn currently matches this color.
    example: input_text.inovelli_auto_hold
  automation_entity_ids:
    description: >-
      Optional list of Home Assistant `automation.*` entity ids to re-enable
      when hold clears.
    example: >-
      ["automation.light_fp2_server_room_motion_detected_lights_on",
      "automation.light_fp2_server_room_motion_cleared_lights_off"]
  prev_led_color_helper:
    description: Optional input_text helper that stores previous LED color (0-255)
    example: input_text.upstairs_primary_water_closet_default_led_color
sequence:
  - variables:
      mmwave_select: select.{{ switch_name }}_mmwavecontrolwireddevice
      mmwave_state: "{{ states(mmwave_select) }}"
      mmwave_available: "{{ mmwave_state not in ['unknown','unavailable','none','None',''] }}"
      normal_mode_input_select_entity: "{{ normal_mode_input_select | default('') | string }}"
      normal_mode_from_input_select: |-
        {% set e = normal_mode_input_select_entity %}
        {% if e.startswith('input_select.') %}
          {% set v = states(e) %}
          {% if v in ['unknown','unavailable','none','None',''] %}
            {{ '' }}
          {% else %}
            {{ v }}
          {% endif %}
        {% else %}
          {{ '' }}
        {% endif %}
      effective_normal_mode: >-
        {% set v = normal_mode_from_input_select | string %}
        {% if (v | length) > 0 %}
          {{ v }}
        {% else %}
          {{ normal_mode | default('') | string }}
        {% endif %}
      led1_on: number.{{ switch_name }}_defaultled1colorwhenon
      led_color_on:
        - number.{{ switch_name }}_defaultled1colorwhenon
        - number.{{ switch_name }}_defaultled2colorwhenon
        - number.{{ switch_name }}_defaultled3colorwhenon
        - number.{{ switch_name }}_defaultled4colorwhenon
        - number.{{ switch_name }}_defaultled5colorwhenon
        - number.{{ switch_name }}_defaultled6colorwhenon
        - number.{{ switch_name }}_defaultled7colorwhenon
      led_color_off:
        - number.{{ switch_name }}_defaultled1colorwhenoff
        - number.{{ switch_name }}_defaultled2colorwhenoff
        - number.{{ switch_name }}_defaultled3colorwhenoff
        - number.{{ switch_name }}_defaultled4colorwhenoff
        - number.{{ switch_name }}_defaultled5colorwhenoff
        - number.{{ switch_name }}_defaultled6colorwhenoff
        - number.{{ switch_name }}_defaultled7colorwhenoff
      manual_hold_color_entity: "{{ manual_hold_color | default('input_text.inovelli_manual_hold') }}"
      auto_hold_color_entity: "{{ auto_hold_color | default('input_text.inovelli_auto_hold') }}"
      manual_hold_color_value: |-
        {% set v = manual_hold_color_entity %}
        {% if v is string and v.startswith('input_') %}
          {{ [ [ states(v) | int(85), 0 ] | max, 255 ] | min }}
        {% else %}
          {{ [ [ v | int(85), 0 ] | max, 255 ] | min }}
        {% endif %}
      auto_hold_color_value: |-
        {% set v = auto_hold_color_entity %}
        {% if v is string and v.startswith('input_') %}
          {{ [ [ states(v) | int(0), 0 ] | max, 255 ] | min }}
        {% else %}
          {{ [ [ v | int(0), 0 ] | max, 255 ] | min }}
        {% endif %}
      hold_color_provided: "{{ (hold_color | default('') | string | length) > 0 }}"
      hold_color_value: |-
        {% set v = hold_color | default('') %}
        {% if v is string and v.startswith('input_') %}
          {{ [ [ states(v) | int(0), 0 ] | max, 255 ] | min }}
        {% else %}
          {{ [ [ v | int(0), 0 ] | max, 255 ] | min }}
        {% endif %}
      current_led1_on: "{{ states(led1_on) | int(0) }}"
      is_on_hold: >-
        {{ (current_led1_on in [manual_hold_color_value, auto_hold_color_value])
        or (mmwave_available and mmwave_state == 'Disabled' and
        (effective_normal_mode | default('') | string) != 'Disabled') }}
      automation_ids: |-
        {% set a = automation_entity_ids | default([]) %}
        {% if a is string %}
          {{ [a] }}
        {% else %}
          {{ a }}
        {% endif %}
      automation_ids_provided: "{{ (automation_ids | default([])) | length > 0 }}"
      helper_provided: "{{ (prev_led_color_helper | default('') | string | length) > 0 }}"
      restore_led_color: |-
        {% if helper_provided %}
          {% set v = states(prev_led_color_helper) %}
          {% if v in ['unknown','unavailable','none','None',''] %}
            255
          {% else %}
            {{ [ [ v | int(255), 0 ] | max, 255 ] | min }}
          {% endif %}
        {% else %}
          255
        {% endif %}
  - choose:
      - conditions:
          - condition: template
            value_template: >-
              {{ is_on_hold and (not hold_color_provided or (current_led1_on ==
              hold_color_value)) }}
        sequence:
          - choose:
              - conditions:
                  - condition: template
                    value_template: >-
                      {{ mmwave_available and (effective_normal_mode |
                      default('') | string | length) > 0 and (effective_normal_mode
                      | string) != 'Disabled' }}
                sequence:
                  - action: select.select_option
                    target:
                      entity_id: "{{ mmwave_select }}"
                    data:
                      option: "{{ effective_normal_mode }}"
          - repeat:
              for_each: "{{ led_color_on }}"
              sequence:
                - action: number.set_value
                  target:
                    entity_id: "{{ repeat.item }}"
                  data:
                    value: "{{ restore_led_color }}"
          - repeat:
              for_each: "{{ led_color_off }}"
              sequence:
                - action: number.set_value
                  target:
                    entity_id: "{{ repeat.item }}"
                  data:
                    value: "{{ restore_led_color }}"
          - delay: "00:00:01"
          - choose:
              - conditions:
                  - condition: template
                    value_template: >-
                      {{ automation_ids_provided and (states(led1_on) | int(0))
                      not in [manual_hold_color_value, auto_hold_color_value] }}
                sequence:
                  - action: automation.turn_on
                    target:
                      entity_id: "{{ automation_ids }}"
    default: []
