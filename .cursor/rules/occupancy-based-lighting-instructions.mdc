---
globs:
  - home-assistant/automations/occupancy-based-lighting/**
  - home-assistant/automations/switch-buttons/**
  - home-assistant/scripts/**
  - home-assistant/cards/**
  - home-assistant/blueprints/**
alwaysApply: false
---
# Occupancy-based lighting: how this repo works

This repo is a working subset of Home Assistant YAML for **occupancy-based lighting zones**, including:

- Dashboard **cards** (Bubble Card popups + buttons)
- **Automations** that turn lights on/off based on occupancy
- **Inovelli mmWave hold** logic (manual + auto/automation holds)
- Helper **input_select** entities used as the “normal mode” source of truth

The goal of these docs is to make it easy (and safe) to update a single zone at a time without accidentally changing other zones.

---

## Overview: `automations/occupancy-based-lighting/`

This folder contains the zone automations that actually drive lighting behavior.

Typical shape per zone:

- **Motion detected → lights on**
  - Example pattern: `automations/occupancy-based-lighting/light_*_<zone>_motion_detected_lights_on.yaml`
- **Motion cleared → lights off**
  - Example pattern: `automations/occupancy-based-lighting/light_*_<zone>_motion_cleared_lights_off.yaml`

**Key concept:** these automations are often **temporarily disabled** during “hold” states so manual/auto holds can take over without fighting the occupancy automations.

---

## Holds (very active work area)

Holds disable “occupancy control” temporarily and indicate state via **reserved LED colors** on the Inovelli LED bar.

### Hold types

- **Manual hold**
  - Triggered by a physical switch action (usually via `automations/switch-buttons/*`)
  - Identified by `input_text.inovelli_manual_hold` (reserved LED color)

- **Auto/automation hold** (e.g. cleaners-mode)
  - Triggered by automations/scripts
  - Identified by `input_text.inovelli_auto_hold` (reserved LED color)

### Hold rules (must follow)

- **Reserved colors are state**
  - Any LED bar color used to indicate “hold” is reserved for that purpose only.
- **Manual vs automation holds must differ**
  - Manual hold uses `input_text.inovelli_manual_hold`
  - Auto/automation hold uses `input_text.inovelli_auto_hold`
- **Clearing behavior**
  - Automations that clear holds must only clear holds matching the **automation hold** color (so manual holds are preserved).

### Manual hold: physical switch → script call

Location: `automations/switch-buttons/*.yaml`

These map switch button events to script calls such as:

- `script.inovelli_toggle_mmwave_hold_led_indicator` (common for manual hold toggle)

**Critical migration detail:** when passing “normal mode” to these scripts, prefer:

- `normal_mode_input_select: input_select.<zone>_mmwave_normal_mode`

### Auto hold: scripts + automations

Auto holds are typically driven by scripts and helper automations, for example:

- Generic scripts under `scripts/inovelli/generic/`
- Zone/group definitions under `scripts/inovelli/entities-defined/`

These often work by:

- Disabling the zone’s occupancy automations
- Setting the Inovelli mmWave control to `Disabled`
- Setting LED colors to a reserved “hold” color
- Later clearing/restoring the mmWave mode + LED state

**Important:** entity-defined scripts frequently store per-zone data in arrays of objects (e.g. `switches:` lists). Only edit the entry where the `switch_name` matches the zone you are changing.

---

## Cards (Bubble Card dashboards)

Cards are stored in `cards/<zone>/` and are maintained as YAML snippets copied out of the HA UI editor.

## Helpers in this repo (important)

In this setup, helpers (`input_select`, `input_text`, etc.) are **created/edited in the Home Assistant UI**, not managed as YAML in this repo.

- **Do not** create per-zone helper YAML files in `helpers/` (we can’t reliably copy/paste/import them back into HA, so they become stale/noisy).
- **Do** keep **one example file per helper type** in `helpers/` as a reference/template (e.g. one mmWave normal-mode `input_select` example, one occupancy off-delay `input_select` example).
- When migrating zones, create the real helper in HA UI, then reference the entity id in cards/automations.

### Completed / canonical examples

Use these as the “known good” patterns:

- `cards/rumpus-room/`
- `cards/concessions/`
- `cards/global/` (cross-zone utilities like “hold all / clear all”)

### Standard UI pattern: 1 button + 2 popups that toggle

- **Entry button** (`*-open-popups.yaml`)
  - `bubble-card` `card_type: button`
  - Navigates to `#<zone>-history`

- **History popup** (`*-history.yaml`)
  - `bubble-card` `card_type: pop-up` with `hash: "#<zone>-history"`
  - Header navigates to `#<zone>-advanced`
  - Includes: key sensors/lights, 1-hour history graph, hold status, automations, normal-mode dropdown, hold buttons

- **Advanced popup** (`*-advanced.yaml`)
  - `bubble-card` `card_type: pop-up` with `hash: "#<zone>-advanced"`
  - Provides a **Back** button returning to `#<zone>-history`
  - Includes deeper device parameters/commands

### Sensor presentation rule-of-thumb

- **Graph-worthy sensors** (you might click for a graph): show as **sub-buttons**
  - Temperature, humidity, illuminance, battery %, occupancy/motion, etc.
- **Text-only status flags**: condense into **markdown**
  - Example: “replace battery soon/now” boolean flags
- **Sub-buttons sizing**: avoid “4 in a row”
  - In `custom:bubble-card` with `card_type: sub-buttons`, do not put 4+ sensors into a single `group:` row.
  - If you have 4 sensors, split into **two groups of two** (e.g. “Inovelli State” + “Other Sensors”).
  - If you have more than 4, keep each group small (typically 2–3 items) and add another named group.

---

## Inovelli presence switch entity id convention (copy/paste trick)

For Inovelli “presence dimmer” devices, the entity ids for mmWave parameters are consistent across zones.

**Rule:** pick a known-good zone card (e.g. concessions or rumpus-room) and **substitute the switch name** everywhere.

### Step-by-step (do this every time)

1. **Pick a source card** that already has the controls you want (e.g. `cards/basement/rumpus-room/*`).
2. **Identify the source switch name** used in that card.
   - Example: `basement_rumpus_room_inovelli_presence`
3. **Decide the target switch name** for the zone you’re building.
   - Example: `basement_server_inovelli_presence`
4. For any entity id that contains the source switch name, **string-replace** it with the target switch name.
   - Example:
     - Source: `sensor.basement_rumpus_room_inovelli_presence_illuminance`
     - Target: `sensor.basement_server_inovelli_presence_illuminance`
   - This works because everything **after** `_inovelli_presence` (the suffix) is consistent across Inovelli presence switches.

### Common suffixes (after `<switch_name>_`)

Replace every occurrence of the source switch name with the target switch name in entity ids like:
  - `select.<switch_name>_mmwavedetectsensitivity`
  - `select.<switch_name>_mmwavedetecttrigger`
  - `select.<switch_name>_mmwavecontrolwireddevice`
  - `select.<switch_name>_outputmode`
  - `select.<switch_name>_smartbulbmode`
  - `number.<switch_name>_mmwaveholdtime`
  - `number.<switch_name>_mmwavestaylife`
  - `number.<switch_name>_mmwavedepthmin` / `mmwavedepthmax`
  - `number.<switch_name>_mmwavewidthmin` / `mmwavewidthmax`
  - `number.<switch_name>_mmwaveheightmin` / `mmwaveheightmax`
  - `sensor.<switch_name>_mmwave_control_commands`

---

## WIP / migration notes (normal_mode → normal_mode_input_select + old cards → new cards)

### Migration: `normal_mode` → `normal_mode_input_select`

We are migrating away from hardcoded `normal_mode: ...` parameters in script calls.

**Rule: match `switch_name`, then replace the parameter in that same block.**

- Find a block targeting a switch:
  - `switch_name: <zone>_inovelli_presence`
- If that same block contains:
  - `normal_mode: ...`
- Replace with:
  - `normal_mode_input_select: input_select.<zone>_mmwave_normal_mode`

Applies across:

- Cards (`cards/**`)
- Switch-button automations (`automations/switch-buttons/**`)
- Entity-defined scripts (`scripts/inovelli/entities-defined/**`)

### Don’t forget the sync automation (helper → device)

If a zone uses `normal_mode_input_select`, ensure it’s included in:

- `automations/inovelli_mmwave_normal_mode_sync_input_select.yaml`

That automation should:

- Trigger on `input_select.<zone>_mmwave_normal_mode`
- Route to `select.<zone>_inovelli_presence_mmwavecontrolwireddevice`

### Don’t forget the “registry lists” (group hold / clear-all scripts)

Some zones are also maintained in centralized “apply to all switches” scripts. When you add a new zone (or migrate it to `normal_mode_input_select`), ensure the zone’s `switch_name` entry is correct in:

- `scripts/inovelli/entities-defined/hold_all_inovelli_presence_controlled_switches.yaml`
  - Add/update the zone’s `automation_entity_ids` so holds properly disable/override occupancy lighting.
- `scripts/inovelli/entities-defined/clear_hold_on_all_inovelli_presence_controlled_switches.yaml`
  - Add/update the zone’s `automation_entity_ids`
  - If the zone uses the input_select pattern, include `normal_mode_input_select: input_select.<zone>_mmwave_normal_mode` (not `normal_mode: Disabled`)

### Migrating cards: old format won’t be in-repo

During migration you will often paste **one zone’s old card YAML** into chat for conversion.

- Assume the old format may not exist in the repo anymore.
- Use `cards/rumpus-room/` and `cards/concessions/` as the reference “new format”.
- Ensure hold buttons in cards pass `normal_mode_input_select` (not a string `normal_mode`).

### New: per-zone “lights off delay” helper + automation pattern

We are migrating away from hardcoded trigger `for:` durations (e.g. `for: "00:05:00"`)
so each zone can control “how long after the room is empty we turn lights off” from the UI.

**Helper (recommended):** use an `input_select` storing `HH:MM:SS` strings.

- Example entity id: `input_select.<zone>_occupancy_off_delay`
- Example options: `00:00:00`, `00:00:15`, `00:00:30`, `00:01:00`, `00:05:00`, `00:15:00`, `00:30:00`

**Automation pattern (motion cleared → lights off):**

- Remove the trigger `for:` entirely
- Add an action `delay:` that reads the helper (fallback to the previous hardcoded value if helper is unavailable)
- Add a post-delay condition to verify the zone is still empty (all relevant sensors still `off`)
- Use `mode: restart` so repeated “fully empty” triggers reset the timer (closest match to trigger `for:` semantics)

**Cards (history popup):**

- In the “Config Drop Down” section, expose:
  - `input_select.<zone>_mmwave_normal_mode`
  - `input_select.<zone>_occupancy_off_delay` (label it “Zone Off Delay” or similar; timer icon recommended)

### Search terms that find what you need

- Find all references for a zone switch:
  - `switch_name: <zone>_inovelli_presence`
- Find old-style parameter usage:
  - `normal_mode:`
- Find new-style parameter usage:
  - `normal_mode_input_select:`

